<!DOCTYPE html>
<html>
<head>
  <title>Review</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --anki-blue: #4A86E8;
      --anki-blue-dark: #3a6cd9;
      --anki-text-dark: #333;
      --anki-text-light: #555;
      --anki-bg-light: #f4f5f7;
      --anki-border: #ddd;
      --anki-focus-border: #99cfff;
      --anki-success: #27ae60; /* Green */
      --anki-error: #e74c3c;   /* Red */

      /* Anki-like button colors for review */
      --anki-again: #e74c3c; /* Red */
      --anki-hard: #f39c12;  /* Orange */
      --anki-good: #2ecc71;  /* Green */
      --anki-easy: #3498db;  /* Blue */
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--anki-bg-light);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      color: var(--anki-text-dark);
      line-height: 1.6;
    }

    .container {
      background-color: #fff;
      padding: 40px 30px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 500px; /* Slightly wider for the card */
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 25px; /* Spacing between main elements */
    }

    h2 {
      color: var(--anki-text-dark);
      font-weight: 700;
      font-size: 1.8em;
      margin-bottom: 0;
    }

    /* The Flashcard itself */
    #card {
      background-color: #fff;
      border: 1px solid var(--anki-border);
      border-radius: 8px;
      padding: 30px 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08); /* Lighter shadow for inner card */
      width: 100%;
      box-sizing: border-box; /* Include padding in width calculation */
      text-align: center;
      display: flex; /* Use flex to control internal element visibility */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 250px; /* Ensure a good height even with minimal content */
    }

    /* Hide elements by default, JS will show them */
    #card > *:not(#noCardsMessage) {
        display: none;
    }

    #kanji {
      font-size: 6em; /* Large kanji character */
      margin-bottom: 20px;
      color: var(--anki-text-dark);
      line-height: 1; /* Remove extra space around the kanji */
    }

    #card p {
      margin: 5px 0; /* Tighten spacing between meaning, onyomi, etc. */
      font-size: 1.1em;
      color: var(--anki-text-light);
    }

    #card strong {
      color: var(--anki-text-dark); /* Make bold labels stand out a bit more */
    }

    /* Review Buttons Group */
    .review-buttons-group {
      display: flex;
      justify-content: space-around; /* Distribute buttons evenly */
      flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
      gap: 10px; /* Space between buttons */
      width: 100%;
    }

    .review-buttons-group button {
      flex: 1; /* Make buttons grow to fill space */
      min-width: 100px; /* Ensure a minimum width */
      padding: 12px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.95em;
      font-weight: 700;
      color: white;
      transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
    }

    /* Individual Review Button Colors */
    .again-button { background-color: var(--anki-again); }
    .hard-button { background-color: var(--anki-hard); }
    .good-button { background-color: var(--anki-good); }
    .easy-button { background-color: var(--anki-easy); }

    .again-button:hover { background-color: #c0392b; }
    .hard-button:hover { background-color: #e67e22; }
    .good-button:hover { background-color: #27ae60; }
    .easy-button:hover { background-color: #2980b9; }

    .review-buttons-group button:active {
      transform: translateY(1px);
    }

    /* Back to Dashboard Button */
    .back-button {
      background: none;
      color: var(--anki-blue);
      text-decoration: none;
      border: none;
      padding: 0;
      font-size: 0.95em;
      cursor: pointer;
      margin-top: 15px; /* Spacing from review buttons */
      transition: color 0.2s ease-in-out;
    }

    .back-button:hover {
      color: var(--anki-blue-dark);
      text-decoration: underline;
    }

    /* No cards message styling */
    .no-cards-message {
      font-size: 1.2em;
      color: var(--anki-text-light);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Review Your Kanji</h2>
    <div id="card">
      <h1 id="kanji"></h1>
      <p><strong>Meaning:</strong> <span id="meaning"></span></p>
      <p><strong>Onyomi:</strong> <span id="onyomi"></span></p>
      <p><strong>Kunyomi:</strong> <span id="kunyomi"></span></p>
      <p><strong>Example:</strong> <span id="example"></span></p>
      <p id="noCardsMessage" class="no-cards-message">Loading card...</p>
    </div>

    <div class="review-buttons-group">
      <button class="again-button" onclick="submitReview('again')">Again</button>
      <button class="hard-button" onclick="submitReview('hard')">Hard</button>
      <button class="good-button" onclick="submitReview('good')">Good</button>
      <button class="easy-button" onclick="submitReview('easy')">Easy</button>
    </div>

    <button class="back-button" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>

  <script>
    let currentCard = null;
    const kanjiElement = document.getElementById('kanji');
    const meaningElement = document.getElementById('meaning');
    const onyomiElement = document.getElementById('onyomi');
    const kunyomiElement = document.getElementById('kunyomi');
    const exampleElement = document.getElementById('example');
    const noCardsMessageElement = document.getElementById('noCardsMessage');
    
    // Select all specific content elements *within* the card, excluding the noCardsMessage
    const cardContentElements = [
        kanjiElement,
        meaningElement.parentElement, // To hide/show the entire <p> for Meaning
        onyomiElement.parentElement,  // To hide/show the entire <p> for Onyomi
        kunyomiElement.parentElement, // To hide/show the entire <p> for Kunyomi
        exampleElement.parentElement  // To hide/show the entire <p> for Example
    ];

    async function fetchNextCard() {
      const username = localStorage.getItem('username');
      if (!username) {
        window.location.href = 'login.html';
        return;
      }

      // 1. Hide all card content and show loading message
      cardContentElements.forEach(el => el.style.display = 'none');
      noCardsMessageElement.innerText = "Loading card...";
      noCardsMessageElement.style.display = 'block';

      try {
        const res = await fetch('http://localhost:3000/api/review/next?user=' + encodeURIComponent(username));
        const data = await res.json();

        if (res.ok && data.card) {
          currentCard = data.card;
          
          // 2. Hide loading message and show card content
          noCardsMessageElement.style.display = 'none';
          cardContentElements.forEach(el => el.style.display = 'block'); // Show card details

          kanjiElement.innerText = currentCard.kanji;
          meaningElement.innerText = currentCard.meaning;
          onyomiElement.innerText = currentCard.onyomi;
          kunyomiElement.innerText = currentCard.kunyomi;
          exampleElement.innerText = currentCard.example;
        } else {
          // 3. No cards or error fetching: hide card content, show appropriate message
          currentCard = null; // Clear current card state
          cardContentElements.forEach(el => el.style.display = 'none'); // Ensure card content is hidden
          noCardsMessageElement.innerText = data.message || 'No cards to review right now. Check back later!';
          noCardsMessageElement.style.display = 'block';
        }
      } catch (error) {
        console.error('Error fetching next card:', error);
        currentCard = null;
        cardContentElements.forEach(el => el.style.display = 'none'); // Ensure card content is hidden
        noCardsMessageElement.innerText = 'Failed to load card. Please try again.';
        noCardsMessageElement.style.display = 'block';
      }
    }

    async function submitReview(rating) {
      if (!currentCard) {
        console.warn('No current card to submit review for.');
        return;
      }

      try {
        const res = await fetch('http://localhost:3000/api/review/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user: localStorage.getItem('username'),
            cardId: currentCard.id,
            rating: rating
          }),
        });

        if (!res.ok) {
          console.error('Failed to submit review:', res.statusText);
          // Optionally display an error message to the user, perhaps on noCardsMessageElement
          noCardsMessageElement.innerText = 'Failed to submit review. Please try again.';
          noCardsMessageElement.style.display = 'block';
        }
      } catch (error) {
        console.error('Network error during review submission:', error);
        noCardsMessageElement.innerText = 'Network error during review. Please try again.';
        noCardsMessageElement.style.display = 'block';
      }

      fetchNextCard(); // Always try to show next card after submission attempt
    }

    // Initial fetch when the page loads
    fetchNextCard();
  </script>
</body>
</html>